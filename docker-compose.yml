version: '2'
services:

  accountdb:
    image: postgres:11
    container_name: accountdb
    hostname: accountdb
    restart: always
    volumes:
      - ./data/postgresql/accountdb.sql:/docker-entrypoint-initdb.d/accountdb.sql
      - ./data/postgresql/accountdb:/var/lib/postgresql/data/
    #ports:
    #   - "5421:5432"
    environment:
      - POSTGRES_USER=signal
      - POSTGRES_PASSWORD=thepassword
      - POSTGRES_DB=accountdb

  messagedb:
    image: postgres:11
    container_name: messagedb
    hostname: messagedb
    restart: always
    volumes:
      - ./data/postgresql/messagedb.sql:/docker-entrypoint-initdb.d/messagedb.sql
      - ../data//postgresql/messagedb:/var/lib/postgresql/data/
    # ports:
    #   - "5422:5432"
    environment:
      - POSTGRES_USER=signal
      - POSTGRES_PASSWORD=thepassword
      - POSTGRES_DB=messagedb
  
  redis:
    image: redis:5.0.7-buster
    container_name: redis
    hostname: redis
    restart: always
    ports:
      - "6379:6379"

  signalserver:
    image: cybergatelabs/signal-server
    container_name: signalserver
    restart: always
    volumes:
       - ./data/signalserver/Signal-Server:/Signal-Server
       - ./data/signalserver/WebSocket-Resources:/WebSocket-Resources
       - ./conf/signalserver/Signal.yml:/Signal-Server/service/config/Signal.yml
    ports:
      - "8080:8080"
      - "8081:8081"

  minio:
    image: minio/minio
    container_name: mino
    hostname: mino
    ports:
      - "9000:9000"
    volumes:
      - ./data/minio/.minio/data:/export
      - ../data/minio/.minio/config:/root/.minio
    environment:
      - "MINIO_ACCESS_KEY=AKIAIG4ILCORMAJCS37A"
      - "MINIO_SECRET_KEY=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"
    command: server /export

  bucket:
    image: minio/mc
    container_name: bucket
    hostname: bucket
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio https://minio:9000 AKIAIG4ILCORMAJCS37A u8cQx07PvHJS8/zvr7q3IFY+w2toIYIJQ7vm1ETH;
      /usr/bin/mc rm -r --force myminio/signal-attachments-buu;
      /usr/bin/mc rm -r --force myminio/signal-profiles-buu;
      /usr/bin/mc mb myminio/signal-attachments-buu;
      /usr/bin/mc mb myminio/signal-profiles-buu;
      /usr/bin/mc policy public myminio/signal-attachments-buu;
      /usr/bin/mc policy public myminio/signal-profiles-buu;
      exit 0;
      "
